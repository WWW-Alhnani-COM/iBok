<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>التحقق برقم الهاتف - iBOK</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <main class="main-content">
    <div class="login-container">
      <h1 class="page-title">التحقق برقم الهاتف</h1>

      <div id="step1">
        <label for="phone">أدخل رقم الهاتف:</label>
        <input type="text" id="phone" placeholder="+967xxxxxxxx" required>
        <div id="recaptcha-container"></div>
        <button id="sendOTP" class="btn-login">إرسال رمز التحقق</button>
      </div>

      <div id="step2" style="display:none;">
        <label for="otp">أدخل الرمز المرسل:</label>
        <input type="text" id="otp" maxlength="6" placeholder="6 أرقام" required>
        <button id="verifyOTP" class="btn-login">تحقق</button>
      </div>

    </div>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// إعدادات Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB8EntKIzd3OfSTqhghCLm68iVwt5WaIRU",
  authDomain: "project-id-77eb2.firebaseapp.com",
  projectId: "project-id-77eb2",
  storageBucket: "project-id-77eb2.appspot.com",
  messagingSenderId: "1061898051036",
  appId: "1:1061898051036:web:0eda29a129b8fce871c319"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', {
  'size': 'invisible'
}, auth);

let confirmationResult;

// إرسال OTP
document.getElementById('sendOTP').addEventListener('click', () => {
  const phone = document.getElementById('phone').value.trim();
  if(!phone) return alert('أدخل رقم الهاتف');

  signInWithPhoneNumber(auth, phone, window.recaptchaVerifier)
    .then(result => {
      confirmationResult = result;
      alert('تم إرسال رمز التحقق إلى هاتفك');
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
      localStorage.setItem('userPhone', phone);
    })
    .catch(error => {
      console.error(error);
      alert('حدث خطأ أثناء إرسال الرمز');
    });
});

// التحقق من OTP
document.getElementById('verifyOTP').addEventListener('click', () => {
  const otp = document.getElementById('otp').value.trim();
  if(!otp) return alert('أدخل الرمز');

  confirmationResult.confirm(otp)
    .then(async (result) => {
      const phone = localStorage.getItem('userPhone');
      alert('تم التحقق بنجاح!');

      // حفظ رقم الهاتف في Firestore
      const userID = phone.replace(/\D/g,''); // تحويل الرقم لمعرف قابل للحفظ
      await setDoc(doc(db, "users", userID), {
        phone: phone,
        verifiedAt: new Date()
      });

      window.location.href = "dashboard.html";
    })
    .catch(err => {
      console.error(err);
      alert('الرمز غير صحيح');
    });
});
</script>
</body>
</html>
